{% extends "base.html" %}
{% block content %}
<h1>Delivery for Order #{{ order.order_id }}</h1>

<!-- KPI summary -->
<div class="kpi">
  <div class="kpi-card">
    <div class="kpi-title">Order Status</div>
    <div class="kpi-value">{{ order.status }}</div>
    <div class="kpi-sub">
      Delivery: {% if order.delivery %}{{ order.delivery.status }}{% else %}Not assigned{% endif %}
    </div>
  </div>
  <div class="kpi-card">
    <div class="kpi-title">Total</div>
    <div class="kpi-value">PKR {{ money_str(total) }}</div>
    <div class="kpi-sub">{{ order.restaurant.name }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-title">Customer</div>
    <div class="kpi-value">
      {{ order.customer_name or order.user.full_name }}
    </div>
    <div class="kpi-sub">
      {{ order.customer_address or order.user.address or "—" }}
    </div>
  </div>
</div>

<!-- Actions -->
<div class="card" style="margin-top:14px">
  <div class="card-title">Actions</div>
  <div class="row">
    {% if order.status == 'Accepted' or order.status == 'Preparing' %}
      <form method="post" action="{{ url_for('agent_update_delivery', oid=order.order_id) }}">
        <input type="hidden" name="action" value="pickup">
        <button class="btn primary" type="submit">Mark Pickup</button>
      </form>
    {% endif %}
    {% if order.status == 'Out for Delivery' %}
      <form method="post" action="{{ url_for('agent_update_delivery', oid=order.order_id) }}">
        <input type="hidden" name="action" value="drop">
        <button class="btn warn" type="submit">Mark Delivered</button>
      </form>
    {% endif %}
    {% if order.status not in ['Accepted','Preparing','Out for Delivery'] %}
      <span class="pill ghost">No actions available</span>
    {% endif %}
  </div>
</div>

<!-- Location updates -->
<div class="card subtle" style="margin-top:14px">
  <div class="card-title">Update Location</div>
  {% if order.delivery %}
    <form class="form" method="post" action="{{ url_for('agent_update_location', delivery_id=order.delivery.delivery_id) }}">
      <div class="row">
        <label>Lat <input name="lat" required placeholder="24.8607"></label>
        <label>Lng <input name="lng" required placeholder="67.0011"></label>
      </div>
      <label>Note <input name="note" placeholder="Near Saddar"></label>
      <button class="btn" type="submit">Send</button>
    </form>
  {% else %}
    <p class="muted">No delivery assignment yet.</p>
  {% endif %}

  {% if last_loc %}
    <div class="mini-body">
      Last update: {{ last_loc.created_at }} — {{ last_loc.lat }}, {{ last_loc.lng }}
      <a class="pill" target="_blank"
         href="https://www.google.com/maps?q={{ last_loc.lat }},{{ last_loc.lng }}">Open in Google Maps</a>
    </div>
  {% endif %}
</div>

<!-- Timeline -->
<div class="card subtle" style="margin-top:14px">
  <div class="card-title">Timeline</div>
  <div class="list">
    {% for h in history %}
      <div class="rowcard">
        <div>
          <div class="title">{{ h.status }}</div>
          <div class="meta">{{ h.created_at }}{% if h.note %} • {{ h.note }}{% endif %}</div>
        </div>
        <div class="tag ok">✓</div>
      </div>
    {% endfor %}
    {% if not history %}
      <p class="muted">No timeline events yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
